#!/bin/sh

DFDIR="$HOME/.dotfiles"

# copy function
function copy_from_dir() {
    for f in $(ls -a "$1"); do
        if ([ ! -r "$HOME/$f" ] || [ "$(readlink -n "$HOME/$f")" != "$1/$f" ]) &&
            [ $f != "." ] && [ $f != ".." ] &&
            [ $f != "README.md" ] &&
            [ $f != ".secrets" ] &&
            [ $f != "secrets" ] &&
            [ $f != "secrets.tar.asc" ] &&
            [ $f != ".git" ] &&
            [ $f != ".gitignore" ] ; then
	        echo "LINKING $f"
	        if ([ -e "$HOME/$f" ] ||
                [ -L "$HOME/$f" ]); then
	            rm -r "$HOME/$f"
	        fi
            ln -s "$1/$f" "$HOME/$f"
        fi
    done
}


# Clone ourselves
if [ ! -r $DFDIR ]; then
  echo "Checking out dotfiles..."
  git clone git://github.com/abscondment/dotfiles.git \
    $DFDIR
fi

# Decrypt any secrets
if [ ! -r "$DFDIR/secrets" ]; then
    echo "Decrypting secrets..."
    if (gpg -da "$DFDIR/secrets.tar.asc" > "$DFDIR/secrets.tar" && tar xvf "$DFDIR/secrets.tar" -C $DFDIR); then
        rm -f "$DFDIR/secrets.tar"
    else
        rm -f "$DFDIR/secrets.tar"
        echo ; echo "Ruh roh. Error decrypting secrets!"
        exit 1
    fi
fi

# actually move things into place
copy_from_dir "$DFDIR"
copy_from_dir "$DFDIR/secrets"
